options:
  max-parallel: 1

image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build & Deploy Nuxt Server
          caches:
            - node
          script:
            # Enable Yarn and install dependencies
            - corepack enable
            - yarn install

            # Inject .env
            - echo "$ENV_CONTENTS" | tr ' ' '\n' > .env
            - cat .env

            # Build for SERVER mode
            - yarn build

            # Setup SSH access
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh-keyscan -H $SERVER >> ~/.ssh/known_hosts

            # Deploy with minimal downtime
            - export APP_PATH="/opt/bitnami/projects/wsoftlabs-website-v2"
            
            # Compress the output directory (handles symlinks properly)
            - tar -czf output.tar.gz .output

            # Upload compressed file and deploy script
            - scp output.tar.gz deploy.sh $SSH_USER@$SERVER:$APP_PATH/

            # Extract on server and deploy
            - ssh $SSH_USER@$SERVER "
                cd $APP_PATH &&
                tar -xzf output.tar.gz &&
                mv .output output-new &&
                rm output.tar.gz &&
                chmod +x deploy.sh &&
                ./deploy.sh
              "


          services:
            - docker